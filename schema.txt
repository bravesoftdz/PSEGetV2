CREATE TABLE MISCTAB (
	MISCKEY	INTEGER PRIMARY KEY,
	DATE INTEGER,
	ADVANCE INTEGER,
	DECLINE INTEGER,
	UNCHANGED INTEGER,
	TRADEDISSUES INTEGER,
	NUMTRADES INTEGER,
	FOREIGNBUY INTEGER,
	FOREIGNSELL INTEGER,
	CROSSVOLUME INTEGER,
	CROSSVALUE INTEGER
);

CREATE UNIQUE INDEX XUQ_MISCTAB_DATE ON MISCTAB (DATE);

CREATE TABLE TRADETAB (
TRADEKEY INTEGER PRIMARY KEY,
DATE NOT NULL,
SYMBOL CHAR(5) NOT NULL,
OPEN NUMERIC(12,5),
HIGH NUMERIC(12,5),
LOW NUMERIC(12,5),
CLOSE NUMERIC(12,5),
VOLUME INTEGER,
VALUE NUMERIC(12,5),
OPENINTEREST INTEGER,
MKTPERCENT NUMERIC(12,5)
);

CREATE UNIQUE INDEX XUQ_TRADETAB_DATE ON TRADETAB(DATE, SYMBOL);

CREATE TRIGGER DELETE_MISC AFTER DELETE ON TRADETAB
BEGIN
  DELETE FROM MISCTAB WHERE DATE = OLD.DATE;
END;

CREATE TRIGGER UPDATE_PRICE_CHANGE AFTER INSERT ON TRADETAB 
BEGIN
  UPDATE TRADETAB SET PERCENTCHG = NEW.CLOSE - 
	(SELECT CLOSE FROM TRADETAB WHERE SYMBOL = NEW.SYMBOL AND DATE < NEW.DATE ORDER BY DATE DESC LIMIT 1) / 
	(SELECT CLOSE FROM TRADETAB WHERE SYMBOL = NEW.SYMBOL AND DATE < NEW.DATE ORDER BY DATE DESC LIMIT 1)
  WHERE SYMBOL = NEW.SYMBOL;

  UPDATE TRADETAB SET GAIN = CLOSE - (SELECT CLOSE FROM TRADETAB WHERE SYMBOL = NEW.SYMBOL AND DATE < NEW.DATE ORDER BY DATE DESC LIMIT 1)
  WHERE SYMBOL = NEW.SYMBOL;	
END;

SELECT C.SYMBOL, C.CLOSE, 
(
  ((C.CLOSE - (SELECT A.CLOSE FROM TRADETAB A WHERE A.SYMBOL = C.SYMBOL AND A.DATE < 1127433600 ORDER BY A.DATE DESC LIMIT 1) ) / 
	     (SELECT B.CLOSE FROM TRADETAB B WHERE B.SYMBOL = C.SYMBOL AND B.DATE < 1127433600 ORDER BY B.DATE DESC LIMIT 1)) * 100
) AS X


FROM TRADETAB C WHERE C.DATE = 1127433600 AND C.SYMBOL NOT LIKE '^%' 
ORDER BY X
DESC LIMIT 10 OFFSET 0;